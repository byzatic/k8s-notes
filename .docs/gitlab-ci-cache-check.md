# GitLab CI: проверка работы кэша (Kubernetes runner)

Этот README описывает минимальный пайплайн, который проверяет, что кэш GitLab CI сохранён на шаге `build` и корректно восстанавливается на шаге `test` на Kubernetes‑раннере.

```yaml
stages: [build, test]

build:
  stage: build
  tags: [k8s, autoscaling]       # твои теги раннера
  cache:
    key: "$CI_PROJECT_NAME"
    policy: push
    paths:
      - .cache/
  script:
    - mkdir -p .cache
    - date > .cache/poke.txt
    - ls -la .cache

test:
  stage: test
  tags: [k8s, autoscaling]
  cache:
    key: "$CI_PROJECT_NAME"
    policy: pull
    paths:
      - .cache/
  script:
    - echo "Restored files:"
    - ls -la .cache || true
    - cat .cache/poke.txt || true
```

## Идея пайплайна

- Два стейджа: `build` и `test`.
- В `build` создаётся директория `.cache/`, записывается маркерный файл `poke.txt` и содержимое каталога выводится в лог. Кэш публикуется (`policy: push`) с ключом `key: "$CI_PROJECT_NAME"`.
- В `test` кэш извлекается (`policy: pull`) с тем же ключом и проверяется наличие файла `poke.txt`.

## Что делает каждый job

### build
- Создаёт `.cache/`.
- Пишет текущую дату в `.cache/poke.txt`.
- Печатает содержимое каталога для наглядности.
- Публикует кэш `.cache/` по ключу проекта.

### test
- Пытается восстановить кэш с тем же ключом.
- Выводит список файлов в `.cache/`.
- Печатает содержимое `.cache/poke.txt` (если он восстановился).

## Ожидаемый результат

1. Job `build` завершается успешно и в логе видны строки о создании `.cache/` и наличии `poke.txt`.
2. Job `test` показывает, что `.cache/` присутствует, и команда `cat .cache/poke.txt` печатает дату из прошлого шага.
3. Это подтверждает, что кэш между стейджами работает на вашем раннере.

## Как запускать и интерпретировать

1. Закоммитьте `.gitlab-ci.yml` в ветку. Пайплайн стартует автоматически.
2. Откройте логи `build` и убедитесь, что:
   - `.cache/` создан,
   - `poke.txt` записан (`date > .cache/poke.txt`),
   - кэш опубликовался без ошибок.
3. Откройте логи `test` и убедитесь, что:
   - список файлов `.cache/` не пуст,
   - команда `cat .cache/poke.txt` отображает дату (значит, кэш восстановлен).

## Типичные проблемы и их причины

| Симптом | Возможная причина | Что проверить/сделать |
|---|---|---|
| `.cache` пуст в job `test` | Разные `cache.key` или другой проект/ветка | Убедитесь, что ключ совпадает и кэш общий для этого проекта. |
| Нет восстановления при `policy: pull` | Кэш ещё не создан (первый прогон) | Запустите пайплайн повторно, после успешного `build`. |
| Кэш теряется между раннерами | Нет общего backend для кэша у раннеров | Настройте общий S3/MinIO backend для кэша GitLab Runner. |
| Ошибки доступа к S3/MinIO | Неверные креды/неверная политика | Проверьте переменные окружения раннера и права бакета. |
| Кэш слишком большой/медленный | В кэш кладутся лишние файлы | Ограничьте `paths:` только нужными каталогами. |

## Рекомендации по улучшению

- Сделайте ключ более избирательным, если нужно кэшировать отдельно по веткам/фичам:  
  `key: "$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG"`
- Для постоянных артефактов между пайплайнами используйте `artifacts`, а для ускорения внутри пайплайна — `cache`.
- Если в проекте есть менеджеры пакетов, добавьте в кэш их директории (`.m2/`, `.gradle/`, `~/.cache/pip` и т.п.).
- На Kubernetes‑раннере убедитесь, что объём ephemeral storage достаточен для вашего кэша.

## Пример ожидаемых фрагментов лога

```
$ mkdir -p .cache
$ date > .cache/poke.txt
$ ls -la .cache
total 8
-rw-r--r--    1 build build         29 Aug 13 10:20 poke.txt
...
$ ls -la .cache
total 8
-rw-r--r--    1 build build         29 Aug 13 10:20 poke.txt
$ cat .cache/poke.txt
Wed Aug 13 10:20:01 UTC 2025
```

## Примечания по безопасности

- Не складывайте в кэш секреты или приватные ключи — кэш могут читать другие джобы этого же проекта.
- Для внешних кэширующих бэкендов используйте отдельные креды с минимально необходимыми правами.
